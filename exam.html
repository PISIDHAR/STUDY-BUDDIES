<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Study Buddies - Exam</title>
<style>
body { font-family: system-ui; background:#f4f6fb; margin:0; padding:0; }
header { background:#2563eb; color:white; text-align:center; padding:15px; font-size:24px; font-weight:bold; }
.container { max-width:900px; margin:auto; padding:20px; }
.q { background:white; border-radius:12px; padding:15px; margin-bottom:10px; box-shadow:0 4px 12px rgba(0,0,0,0.06);}
button { background:#2563eb; color:white; border:none; padding:10px 15px; border-radius:8px; cursor:pointer; margin-top:10px;}
button:hover { background:#1d4ed8; }
#editor { width:100%; height:220px; }
#timer { font-weight:bold; text-align:right; font-size:18px; margin-bottom:10px; }
input, select { width:100%; padding:8px; margin-bottom:5px; border-radius:5px; border:1px solid #ccc; }
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs, setDoc, doc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBBqjtuJ50YrJQ7Mrf6M_MnwSdO96ici-k",
  authDomain: "study-buddies-exam.firebaseapp.com",
  projectId: "study-buddies-exam",
  storageBucket: "study-buddies-exam.firebasestorage.app",
  messagingSenderId: "1017595202024",
  appId: "1:1017595202024:web:67568199ddfe235bca3c5d",
  measurementId: "G-J2YJ12TB7Z"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let questions = [], answers = [];
let playerName='', playerEmail='', selectedSection='';

const qDiv=document.createElement('div');
qDiv.id="questions";

async function loadQuestions() {
  qDiv.innerHTML = '<p>Loading questions...</p>';
  try {
    const snap = await getDocs(collection(db,"questions"));
    questions = [];
    snap.forEach(d => {
      const q = d.data();
      q.id = d.id;
      if(q.section === selectedSection) questions.push(q);
    });
    if(questions.length===0){ qDiv.innerHTML='<p>No questions set for this section.</p>'; return; }
    answers = new Array(questions.length).fill(null);
    renderQuestions();
  } catch(e) { qDiv.innerHTML='<p style="color:red;">Error loading questions!</p>'; console.error(e); }
}

function renderQuestions() {
  qDiv.innerHTML = "";
  questions.forEach((q,i)=>{
    const div = document.createElement('div');
    div.className = 'q';
    div.innerHTML = `<b>Q${i+1}. ${q.question}</b><br>`;
    q.options.forEach((opt,idx)=>{
      const label = document.createElement('label');
      const radio = document.createElement('input');
      radio.type = 'radio';
      radio.name = 'q'+i;
      radio.value = idx;
      radio.addEventListener('change',()=>{
        const correctIndex = Number(q.correct);
        answers[i] = (idx === correctIndex) ? 3 : 2;
      });
      label.appendChild(radio);
      label.appendChild(document.createTextNode(' ' + opt));
      div.appendChild(label);
      div.appendChild(document.createElement('br'));
    });
    qDiv.appendChild(div);
  });
}

window.startExam = async ()=>{
  const name = document.getElementById('playerName').value.trim();
  const email = document.getElementById('playerEmail').value.trim();
  selectedSection = document.getElementById('sectionSelect').value;
  if(!name || !email || !selectedSection){ alert("Enter all details and select section!"); return; }
  playerName=name; playerEmail=email;
  await loadQuestions();
  if(questions.length===0) return;

  document.getElementById('userInfo').style.display='none';
  document.getElementById('examArea').style.display='block';
  document.getElementById('examArea').prepend(qDiv);

  let timeLeft = 60*60;
  const timer = document.getElementById('timer');
  const t = setInterval(()=>{
    timeLeft--;
    const m = Math.floor(timeLeft/60), s = timeLeft%60;
    timer.textContent = `⏳ Time Left: ${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    if(timeLeft<=0){ clearInterval(t); submitExam(); }
  },1000);
}

window.submitExam = async ()=>{
  let score=0;
  answers.forEach(ans=>{ if(ans===3) score++; });

  try{
    const resultId="result_"+Date.now();
    await setDoc(doc(db,"results",resultId),{
      name: playerName,
      email: playerEmail,
      section: selectedSection,
      score,
      total:questions.length,
      answers,
      createdAt: serverTimestamp()
    });
  }catch(err){ console.error(err); alert("Result save failed!"); }

  localStorage.setItem("sb_state",JSON.stringify({
    name: playerName,
    email: playerEmail,
    section: selectedSection,
    score,
    total: questions.length,
    answers,
    questions
  }));

  window.location.href="result.html";
}

// --- Admin ---
window.openEditor = ()=>{
  const pass = prompt("Enter Admin Password:");
  if(pass!=="DARSHILISBEST"){alert("Wrong password"); return;}
  document.getElementById('editorBox').style.display="block";
  document.getElementById('addQuestionBox').style.display="block";
}

window.addNewQuestion = async ()=>{
  const q = document.getElementById('newQ').value.trim();
  const opt1 = document.getElementById('opt1').value.trim();
  const opt2 = document.getElementById('opt2').value.trim();
  const opt3 = document.getElementById('opt3').value.trim();
  const opt4 = document.getElementById('opt4').value.trim();
  const correctIndex = Number(document.getElementById('correctIndex').value);
  const sec = document.getElementById('newSection').value;

  if(!q || !opt1 || !opt2 || !opt3 || !opt4 || isNaN(correctIndex) || !sec) {
    alert("⚠️ Please fill all fields and select section.");
    return;
  }

  try {
    const id = "q" + Date.now();
    await setDoc(doc(db,"questions",id),{
      question: q,
      options: [opt1,opt2,opt3,opt4],
      correct: correctIndex,
      section: sec
    });
    alert("✅ Question Added!");
    document.getElementById('newQ').value="";
    document.getElementById('opt1').value="";
    document.getElementById('opt2').value="";
    document.getElementById('opt3').value="";
    document.getElementById('opt4').value="";
    document.getElementById('correctIndex').value="";
    document.getElementById('newSection').value="";
    await loadQuestions();
  } catch (e) {
    console.error(e);
    alert("❌ Error adding question: " + e.message);
  }
};
</script>
</head>
<body>
<header>📚 Study Buddies Exam</header>
<div class="container">
  <div id="userInfo">
    <h3>Enter Your Details</h3>
    <input type="text" id="playerName" placeholder="Your Name" required>
    <input type="email" id="playerEmail" placeholder="Your Email" required>
    <select id="sectionSelect">
      <option value="">Select Section</option>
      <option value="5-7">Section 5-7</option>
      <option value="8-10">Section 8-10</option>
    </select>
    <button onclick="startExam()">Start Exam</button>
  </div>

  <div id="examArea" style="display:none;">
    <div id="timer">⏳ Time Left: 60:00</div>
    <button onclick="submitExam()">Submit Exam</button>
    <button onclick="openEditor()">✏️ Admin Edit</button>

    <div id="editorBox" style="display:none;margin-top:15px;">
      <h4>Add New Question</h4>
      <input type="text" id="newQ" placeholder="Enter Question">
      <input type="text" id="opt1" placeholder="Option 1">
      <input type="text" id="opt2" placeholder="Option 2">
      <input type="text" id="opt3" placeholder="Option 3">
      <input type="text" id="opt4" placeholder="Option 4">
      <input type="number" id="correctIndex" min="0" max="3" placeholder="Correct Option Index (0-3)">
      <select id="newSection">
        <option value="">Select Section</option>
        <option value="5-7">Section 5-7</option>
        <option value="8-10">Section 8-10</option>
      </select>
      <button onclick="addNewQuestion()">➕ Add</button>
    </div>
  </div>
</div>
</body>
</html>
